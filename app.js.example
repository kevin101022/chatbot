// ============================================
// HADES - Chatbot Frontend con OpenAI API
// ============================================

// CONFIGURACI√ìN - IMPORTANTE: Configura tu API key aqu√≠
// Copia este archivo como app.js y reemplaza 'tu-api-key-aqui' con tu API key real
const OPENAI_API_KEY = 'tu-api-key-aqui'; // Reemplaza con tu API key de OpenAI
const OPENAI_API_URL = 'https://api.openai.com/v1/chat/completions';
const MODEL = 'gpt-4'; // Puedes cambiar a 'gpt-3.5-turbo' para ahorrar costos

// Leer el prompt del sistema
let SYSTEM_PROMPT = '';

// Elementos del DOM
let chatForm, userInput, chatMessages, sendButton, loadingIndicator;

// Inicializaci√≥n
document.addEventListener('DOMContentLoaded', async () => {
    // Cargar prompt del sistema
    await loadSystemPrompt();
    
    // Obtener elementos del DOM
    chatForm = document.getElementById('chatForm');
    userInput = document.getElementById('userInput');
    chatMessages = document.getElementById('chatMessages');
    sendButton = document.getElementById('sendButton');
    loadingIndicator = document.getElementById('loadingIndicator');
    
    // Inicializar funcionalidades
    initParticleBackground();
    setupEventListeners();
    
    // Verificar API key
    if (OPENAI_API_KEY === 'tu-api-key-aqui') {
        showWarning('‚ö†Ô∏è Por favor, configura tu API key de OpenAI en app.js');
    }
    
    // Enfocar el input
    if (userInput) {
        userInput.focus();
    }
});

// ============================================
// CARGAR PROMPT DEL SISTEMA
// ============================================

async function loadSystemPrompt() {
    try {
        const response = await fetch('hades_prompt.txt');
        if (response.ok) {
            SYSTEM_PROMPT = await response.text();
        } else {
            // Si no se puede cargar, usar prompt por defecto
            SYSTEM_PROMPT = getDefaultPrompt();
        }
    } catch (error) {
        console.warn('No se pudo cargar hades_prompt.txt, usando prompt por defecto:', error);
        SYSTEM_PROMPT = getDefaultPrompt();
    }
}

function getDefaultPrompt() {
    return `Soy Hades, un chatbot experto en desarrollo de software. Mi especialidad incluye programaci√≥n de aplicaciones web, m√≥viles, sistemas, bases de datos, arquitecturas de software, metodolog√≠as √°giles, herramientas de desarrollo, buenas pr√°cticas de c√≥digo y soluciones a errores comunes.

Solo respondo preguntas relacionadas con desarrollo de software. Si me preguntan algo fuera de mi especialidad, debo responder educadamente: "Lo siento, no soy experto en este tema, pero puedo ayudarte con cualquier duda relacionada con desarrollo de software."

Mis respuestas deben ser claras, concisas, con ejemplos de c√≥digo cuando sea necesario y promover buenas pr√°cticas de desarrollo.`;
}

// ============================================
// EVENT LISTENERS
// ============================================

function setupEventListeners() {
    chatForm.addEventListener('submit', handleSubmit);
    
    userInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            chatForm.dispatchEvent(new Event('submit'));
        }
    });
    
    userInput.addEventListener('input', () => {
        if (userInput.value.trim()) {
            sendButton.disabled = false;
        } else {
            sendButton.disabled = true;
        }
    });
}

// ============================================
// HANDLE SUBMIT
// ============================================

async function handleSubmit(e) {
    e.preventDefault();
    
    const message = userInput.value.trim();
    if (!message) return;
    
    // Deshabilitar input
    userInput.disabled = true;
    sendButton.disabled = true;
    
    // Mostrar mensaje del usuario
    addUserMessage(message);
    
    // Limpiar input
    userInput.value = '';
    
    // Mostrar loading
    showLoading();
    
    try {
        // Verificar API key
        if (OPENAI_API_KEY === 'tu-api-key-aqui') {
            throw new Error('API key no configurada. Por favor, configura OPENAI_API_KEY en app.js');
        }
        
        // Enviar mensaje a OpenAI
        const response = await sendToOpenAI(message);
        
        // Ocultar loading
        hideLoading();
        
        // Mostrar respuesta
        addBotMessage(response);
        
    } catch (error) {
        hideLoading();
        console.error('Error:', error);
        addBotMessage(
            `‚ùå Error: ${error.message}\n\n` +
            `Por favor, verifica que:\n` +
            `1. Tu API key de OpenAI est√© configurada correctamente\n` +
            `2. Tengas cr√©ditos disponibles en tu cuenta de OpenAI\n` +
            `3. Tu conexi√≥n a internet funcione correctamente`
        );
    } finally {
        // Rehabilitar input
        userInput.disabled = false;
        sendButton.disabled = false;
        userInput.focus();
    }
}

// ============================================
// OPENAI API INTEGRATION
// ============================================

async function sendToOpenAI(userMessage) {
    const response = await fetch(OPENAI_API_URL, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${OPENAI_API_KEY}`
        },
        body: JSON.stringify({
            model: MODEL,
            messages: [
                {
                    role: 'system',
                    content: SYSTEM_PROMPT
                },
                {
                    role: 'user',
                    content: userMessage
                }
            ],
            temperature: 0.7,
            max_tokens: 2000
        })
    });
    
    if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error?.message || `Error ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    return data.choices[0].message.content;
}

// ============================================
// MESSAGE DISPLAY
// ============================================

function addUserMessage(text) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message user-message mb-6 flex gap-4 flex-row-reverse animate-fadeIn';
    messageDiv.innerHTML = `
        <div class="flex-shrink-0 w-12 h-12 rounded-full bg-gray-700 flex items-center justify-center text-2xl shadow-lg">
            üë§
        </div>
        <div class="flex-1 flex justify-end">
            <div class="bg-gradient-to-br from-gray-800 to-gray-900 border-r-4 border-inferno-red rounded-lg p-4 shadow-lg max-w-[85%]">
                <p class="text-white">${escapeHtml(text)}</p>
            </div>
        </div>
    `;
    
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
}

function addBotMessage(text) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message bot-message mb-6 flex gap-4 animate-fadeIn';
    
    // Formatear el texto (preservar saltos de l√≠nea y formatear c√≥digo)
    const formattedText = formatMessage(text);
    
    messageDiv.innerHTML = `
        <div class="flex-shrink-0 w-12 h-12 rounded-full bg-gradient-to-br from-inferno-red to-inferno-orange flex items-center justify-center text-2xl glow-animation shadow-lg shadow-inferno-red/50">
            ‚ö°
        </div>
        <div class="flex-1">
            <div class="bg-gray-800/90 border-l-4 border-inferno-red rounded-lg p-4 shadow-lg">
                ${formattedText}
            </div>
        </div>
    `;
    
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
    
    // Resaltar c√≥digo despu√©s de insertar
    messageDiv.querySelectorAll('pre code').forEach((block) => {
        hljs.highlightElement(block);
    });
}

function formatMessage(text) {
    // Convertir saltos de l√≠nea a <br>
    let formatted = escapeHtml(text);
    
    // Formatear bloques de c√≥digo entre ```
    formatted = formatted.replace(/```(\w+)?\n?([\s\S]*?)```/g, (match, lang, code) => {
        const language = lang || '';
        return `<pre class="bg-black/50 border border-gray-700 rounded-lg p-4 my-3 overflow-x-auto"><code class="language-${language}">${escapeHtml(code.trim())}</code></pre>`;
    });
    
    // Formatear c√≥digo inline entre `
    formatted = formatted.replace(/`([^`\n]+)`/g, '<code class="bg-gray-900/50 px-2 py-1 rounded text-inferno-orange border border-gray-700 text-sm">$1</code>');
    
    // Convertir saltos de l√≠nea a <br>
    formatted = formatted.replace(/\n/g, '<br>');
    
    // Formatear texto en negrita **texto**
    formatted = formatted.replace(/\*\*(.+?)\*\*/g, '<strong class="text-inferno-orange">$1</strong>');
    
    // Formatear listas
    formatted = formatted.replace(/^\- (.+)$/gm, '<li class="ml-4 mb-1">$1</li>');
    formatted = formatted.replace(/(<li.*<\/li>\n?)+/g, '<ul class="list-disc list-inside my-2 space-y-1">$&</ul>');
    
    return `<div class="prose prose-invert max-w-none">${formatted}</div>`;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function scrollToBottom() {
    chatMessages.scrollTo({
        top: chatMessages.scrollHeight,
        behavior: 'smooth'
    });
}

// ============================================
// LOADING INDICATOR
// ============================================

function showLoading() {
    loadingIndicator.classList.remove('hidden');
    loadingIndicator.classList.add('flex', 'flex-col');
}

function hideLoading() {
    loadingIndicator.classList.add('hidden');
    loadingIndicator.classList.remove('flex', 'flex-col');
}

// ============================================
// PARTICLE BACKGROUND
// ============================================

function initParticleBackground() {
    const canvas = document.getElementById('particleCanvas');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    
    // Ajustar tama√±o del canvas
    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
    
    // Part√≠culas
    const particles = [];
    const particleCount = 60;
    
    class Particle {
        constructor() {
            this.reset();
        }
        
        reset() {
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * canvas.height;
            this.size = Math.random() * 2 + 1;
            this.speedX = Math.random() * 0.5 - 0.25;
            this.speedY = Math.random() * 0.5 - 0.25;
            this.opacity = Math.random() * 0.5 + 0.2;
            this.color = Math.random() > 0.5 ? '#ff3b3b' : '#ff6b35';
        }
        
        update() {
            this.x += this.speedX;
            this.y += this.speedY;
            
            if (this.x < 0 || this.x > canvas.width) this.speedX *= -1;
            if (this.y < 0 || this.y > canvas.height) this.speedY *= -1;
        }
        
        draw() {
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fillStyle = this.color;
            ctx.globalAlpha = this.opacity;
            ctx.shadowBlur = 10;
            ctx.shadowColor = this.color;
            ctx.fill();
            ctx.globalAlpha = 1;
        }
    }
    
    // Crear part√≠culas
    for (let i = 0; i < particleCount; i++) {
        particles.push(new Particle());
    }
    
    // Animaci√≥n
    function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        particles.forEach(particle => {
            particle.update();
            particle.draw();
        });
        
        requestAnimationFrame(animate);
    }
    
    animate();
}

// ============================================
// UTILITY FUNCTIONS
// ============================================

function showWarning(message) {
    const warningDiv = document.createElement('div');
    warningDiv.className = 'fixed top-4 right-4 bg-yellow-900/90 border-l-4 border-yellow-400 text-yellow-100 px-4 py-3 rounded-lg shadow-lg z-50 max-w-md';
    warningDiv.innerHTML = `<p class="font-semibold">${escapeHtml(message)}</p>`;
    document.body.appendChild(warningDiv);
    
    setTimeout(() => {
        warningDiv.remove();
    }, 5000);
}

